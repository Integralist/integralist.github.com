<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
        <title>Dev Environments within Docker Containers</title>
        <link rel="stylesheet" href="../styles/github-markdown.css">
        <link rel="stylesheet" href="../styles/prism-default.css">
        <style>
            body {
                min-width: 200px;
                max-width: 790px;
                margin: 0 auto;
                padding: 30px;
            }

            pre[class*="language-"] {
              border: 1px dashed #AAA;
              margin-bottom: 1em;
            }
        </style>
    </head>
    <body>
        <article class="markdown-body">
          <ul class="top-nav">
              <li><a href="../index.html">Home</a></li>
              <li><a href="../posts/about.html">About Me</a></li>
              <li><a href="https://github.com/integralist">GitHub</a></li>
              <li><a href="https://twitter.com/integralist">Twitter</a></li>
              <li><a href="http://www.integralist.co.uk/resume">Resume</a></li>
          </ul>

<h1>Dev Environments within Docker Containers</h1>

<ul>
<li><a href="#1">Introduction</a></li>
<li><a href="#2">Python</a></li>
<li><a href="#3">Go</a></li>
<li><a href="#4">Mounting Volumes</a></li>
</ul>

<div id="1"></div>

<h2>Introduction</h2>

<p>You&#39;re a software engineer with a new laptop.</p>

<p>You&#39;re going to be writing code in multiple languages.</p>

<p>You&#39;re going to have projects of varying dependencies.</p>

<p>But you want to avoid the issues you&#39;ve had in the past:</p>

<ul>
<li><p>Messy installations of lots of different software packages.</p></li>
<li><p>Clogging up your system with programming language version managers.</p></li>
</ul>

<p>You decide to use <a href="https://www.docker.com/">Docker</a>.</p>

<p>It&#39;s a dependency sure, but you&#39;ve got to install <em>something</em>!</p>

<p>With Docker it allows your environment to stay clean.</p>

<p>So let&#39;s see two simple examples:</p>

<ol>
<li><a href="https://www.python.org/">Python</a></li>
<li><a href="https://golang.org/">Go</a></li>
</ol>

<blockquote>
<p>Note: I don&#39;t claim this to be &#39;the way&#39; to do this.<br>
This is just a setup that works well enough for me.<br>
I&#39;m also a Vim user, so your mileage may vary.</p>
</blockquote>

<div id="2"></div>

<h2>Python</h2>

<p>You have a Python project you need to work on.</p>

<blockquote>
<p>I won&#39;t explain how Python works, I&#39;ll presume you&#39;re a Pythonista</p>
</blockquote>

<p>Here&#39;s the folder structure we&#39;re dealing with:</p>

<pre><code class="language-text">foo-project/
| Dockerfile
| Makefile
| app.py
| requirements.txt
</code></pre>

<p>We have a Dockerfile (naturally), along with a Makefile to allow us to more easily build our docker image. We also have an application script + a set of dependencies. Nice and simple.</p>

<p>So here&#39;s what the Dockerfile looks like:</p>

<pre><code class="language-docker">FROM python:3.6.1

WORKDIR /tmp

RUN apt-get update -y
RUN apt-get install -y git ncurses-dev
RUN git clone https://github.com/vim/vim.git &amp;&amp; cd vim &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install

ADD ./requirements.txt /app/requirements.txt
RUN pip install -r /app/requirements.txt

COPY .vim /root/.vim
COPY .vimrc /root/.vimrc

WORKDIR /app
</code></pre>

<p>As you can see we&#39;re building our Docker image from an official Python base image (at the time of writing it&#39;s the latest Python version).</p>

<p>We jump into a tmp directory so that we can install some dependencies required to get our setup just how we want it. So this means installing <code>git</code> so we can clone down the latest build of Vim and we also install <code>ncurses-dev</code> which is necessary in order to compile Vim.</p>

<p>After that we copy our <code>requirements.txt</code> file into the image and install the packages specified inside that file. We also add in our <code>.vim</code> directory and <code>.vimrc</code> file to the image.</p>

<blockquote>
<p>Note: the Makefile has a command for copying <code>.vim/.vimrc</code> into the current project directory, as <code>docker build</code> has a specific context environment that is effectively the location of the Dockerfile</p>
</blockquote>

<p>Next we have the Makefile:</p>

<pre><code class="language-make">copy_vim_files:
  @if [ ! -d &quot;./.vim&quot; ]; then cp -r &quot;$$HOME/.vim&quot; ./.vim; fi
  @if [ ! -f &quot;./.vimrc&quot; ]; then cp &quot;$$HOME/.vimrc&quot; ./.vimrc; fi

remove_vim_files:
  @rm -rf ./.vim
  @rm ./.vimrc

build: copy_vim_files
  @docker build -t python-container-with-vim .

run: build
  @docker run -it -v &quot;$$(pwd)&quot;:/app python-container-with-vim /bin/bash

clean: remove_vim_files
  -@docker rmi -f python-container-with-vim &amp;&gt; /dev/null || true

rebuild: clean run
</code></pre>

<p>There&#39;s lots going on in there, but the important thing to know is that to start up your docker container (with Python and Vim pre-installed) is to use:</p>

<pre><code class="language-bash">make run
</code></pre>

<p>This will copy over the host <code>.vim/.vimrc</code> directory/files, then build a new image and then call <code>docker run ...</code> where it&#39;ll mount the project directory as a volume into the running container.</p>

<p>Once you&#39;re inside the container just execute <code>vim app.py</code> and off you go writing code.</p>

<p>Just for completion, here is our application script:</p>

<pre><code class="language-python">print(&#39;hi&#39;)
food = &quot;is a thing&quot;  # if linting is installed properly this will error


def hello(message):
    &quot;&quot;&quot;
    My summary line starts capitalized and ends with a period.

    my bigger description is going here
    so pay attention to what it says
    &quot;&quot;&quot;
    print(message)
</code></pre>

<p>The above script has some &#39;linting&#39; issues, so if our packages (see below) are installed correctly then we should see Vim highlight the issue to us.</p>

<pre><code class="language-text">flake8==3.2.1
flake8-deprecated==1.1
flake8-docstrings==1.0.3
flake8-mock==0.3
flake8-quotes==0.9.0
mypy==0.501
pep8-naming==0.4.1
pylint==1.6.4
pytest==3.0.5
</code></pre>

<p>We can see from the <code>requirements.txt</code> file that we&#39;ve installed a few different linters along with the MyPy static analysis tool.</p>

<p>That&#39;s it really. You can reuse the Dockerfile and Makefile for all your projects as they don&#39;t do anything specific to this project. Just setup the docker image/container so you can execute <code>make run</code> and start developing.</p>

<div id="3"></div>

<h2>Go</h2>

<p>You have a Go project you need to work on.</p>

<blockquote>
<p>I won&#39;t explain how Go works, I&#39;ll presume you&#39;re a Gopher</p>
</blockquote>

<p>Here&#39;s the folder structure we&#39;re dealing with:</p>

<pre><code class="language-text">bar-project/
| Dockerfile
| Dockerfile-compile
| Godeps
| Makefile
| app.go
</code></pre>

<p>So here&#39;s our main Dockerfile:</p>

<pre><code class="language-docker">FROM golang:1.8

RUN apt-get update -y
RUN apt-get install -y wget git ncurses-dev time

WORKDIR /tmp
RUN git clone https://github.com/vim/vim.git &amp;&amp; cd vim &amp;&amp; make &amp;&amp; make install

WORKDIR /go/src
COPY .vim /root/.vim
COPY .vimrc /root/.vimrc
COPY ./Godeps /go/src

RUN wget https://raw.githubusercontent.com/pote/gpm/v1.4.0/bin/gpm &amp;&amp; chmod +x gpm &amp;&amp; mv gpm /usr/local/bin
RUN gpm install
RUN cp -r ./github.com /github.com  # backup packages to root to prevent volume mount removing it

# Install Go binaries that are utilised by the vim-go plugin:
# https://github.com/fatih/vim-go/blob/master/plugin/go.vim#L9
#
# We don&#39;t manually install them, we let vim-go handle that
# We use vim&#39;s `execute` command to pipe commands
# This helps avoid &quot;Press ENTER or type command to continue&quot;
RUN time vim -c &quot;execute &#39;silent GoUpdateBinaries&#39; | execute &#39;quit&#39;&quot;
</code></pre>

<p>Again we&#39;re not doing anything too crazy (not until the end, which I&#39;ll explain). We&#39;re building a new image from an official base image, then we&#39;re installing dependencies that allow us to manually compile the Vim editor.</p>

<p>Next we copy over our vim files and the <code>Godeps</code> dependencies file and we install our dependency manager <a href="https://github.com/pote/gpm">gpm</a> and install the packages we want to use within our application.</p>

<p>Next we back up the installed depedencies (<code>./github.com</code>) to another directory. The reason we do that is because when we mount our host project directory into the running container we will end up accidentally replacing the installed packages.</p>

<p>Finally we run vim and pass it a script to be executed once Vim has loaded. What this does is allow the statically built image to include the updated set of depedencies that the <a href="https://github.com/fatih/vim-go">vim-go</a> plugin requires. I could have installed them manually, but then using the built in command provided by vim-go means I don&#39;t have to ensure my list of go tools still matches up to what vim-go is using.</p>

<p>The downside to this is that when you build the image, you&#39;ll see (for ~20-30 seconds) Vim started and you wont be able to interact with it at all during that time. This is because it&#39;s installing the dependencies it uses. But after that, Vim will close and you&#39;ll be placed at the containers shell prompt. From there you can run Vim and start coding.</p>

<p>Here&#39;s the Go Makefile (it works similarly to the Python one):</p>

<pre><code class="language-make">copy_vim_files:
  @if [ ! -d &quot;./.vim&quot; ]; then cp -r &quot;$$HOME/.vim&quot; ./.vim; fi
  @if [ ! -f &quot;./.vimrc&quot; ]; then cp &quot;$$HOME/.vimrc&quot; ./.vimrc; fi

remove_vim_files:
  @rm -rf ./.vim
  @rm ./.vimrc

build: copy_vim_files
  @docker build -t go-container-with-vim .

run: build remove_vim_files
  @docker run -it -v &quot;$$(pwd)&quot;:/go/src go-container-with-vim /bin/bash

clean: remove_vim_files
  -@docker rmi -f go-container-with-vim &amp;&gt; /dev/null || true
  -@rm ./app &amp;&gt; /dev/null || true

rebuild: clean run

uninstall: clean
  -@rm /usr/local/bin/app &amp;&gt; /dev/null || true

gobuild:
  go build -o ./carbon

install: gobuild
  cp ./carbon  /usr/local/bin/carbon
  rm ./carbon

compile:
  @docker build -t go-compiler -f ./Dockerfile-compile .
  @docker run -it -v &quot;$$(pwd)&quot;:/go/src go-compiler || true
</code></pre>

<p>There&#39;s a few more steps in the Go Makefile and that&#39;s just for the purposes of having a separate Dockerfile for compiling our application. The following is the other Dockerfile we have in our project:</p>

<pre><code class="language-docker">FROM golang:1.8

WORKDIR /go/src
COPY ./Godeps /go/src

RUN apt-get update &amp;&amp; apt-get install wget
RUN wget https://raw.githubusercontent.com/pote/gpm/v1.4.0/bin/gpm &amp;&amp; chmod +x gpm &amp;&amp; mv gpm /usr/local/bin
RUN gpm install
RUN cp -r ./github.com /github.com  # backup packages to root to prevent volume mount removing it

CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;cp -fr /github.com ./github.com &amp;&amp; go build -o app . &amp;&amp; ./app&quot;]
</code></pre>

<p>This Dockerfile does much the same thing: get dependency file, install those specified dependencies, then back them up to another directory.</p>

<p>Finally, when the container is run we use a subshell to run multiple tasks at once (some people prefer having a dedicated run script for this, but whatever).</p>

<p>The tasks we run are:</p>

<ol>
<li>copy the backed up dependencies back into the mounted project directory</li>
<li>build the app using the default compiler for the OS †</li>
<li>execute the compiled binary to show it can run correctly inside the container</li>
</ol>

<blockquote>
<p>† this means our compiled binary will be a linux based binary, so you can&#39;t run it on your host machine if it&#39;s not linux based (e.g. I&#39;m using macOS). If you want to compiled for multiple OS&#39;s then consider using <a href="https://github.com/mitchellh/gox">Gox</a></p>
</blockquote>

<p>Now here is our Go application, it simply uses the logging dependency we&#39;ve installed and that&#39;s it. Nothing too fancy necessary for this example.</p>

<pre><code class="language-go">package main

import (
  &quot;fmt&quot;

  log &quot;github.com/Sirupsen/logrus&quot;
)

func init() {
  log.SetLevel(log.DebugLevel) // otherwise would not be shown
}

func main() {
  fmt.Println(&quot;Hello World!&quot;)

  logger := log.WithFields(log.Fields{
    &quot;name&quot;: &quot;hello-world-app&quot;,
  })
  logger.Debug(&quot;this is my debug log message&quot;)
  logger.Info(&quot;this is my info log message&quot;)
  logger.Warn(&quot;this is my warn log message&quot;)
  logger.Error(&quot;this is my error log message&quot;)
  logger.Fatal(&quot;this is my Fatal log message&quot;)
  logger.Panic(&quot;this is my Panic log message&quot;) // we don&#39;t actually reach here
}
</code></pre>

<p>Here is our dependency file&#39;s content, where we can see the <a href="https://github.com/sirupsen/logrus">Logrus</a> dependency we&#39;ve specified:</p>

<pre><code class="language-text">github.com/sirupsen/logrus 10f801ebc38b33738c9d17d50860f484a0988ff5
</code></pre>

<div id="4"></div>

<h2>Mounting Volumes</h2>

<p>Just remember that when making changes inside the container, because you&#39;ve mounted your host project directory as a volume, if you make a change or add a new file or compile something inside of the container; then it&#39;ll be available on your host machine.</p>

<p>This is all fine, but you might want to look at setting up a <code>.gitignore</code> file to ensure you don&#39;t accidentally commit any unwanted items into your git repository.</p>

            <hr>
            <h2>Links</h2>
            <ul>
                <li><a href="../index.html">Home</a></li>
                <li><a href="../posts/about.html">About Me</a></li>
                <li><a href="https://github.com/integralist">GitHub</a></li>
                <li><a href="https://twitter.com/integralist">Twitter</a></li>
                <li><a href="http://www.integralist.co.uk/resume">Resume</a></li>
            </ul>
        </article>
        <script src="../scripts/prism.js"></script>
        <script>
            var _gaq=[['_setAccount','UA-33159515-1'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>
