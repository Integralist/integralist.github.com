<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
  <head>
    <title>Integralist</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="../../assets/css/main.css" />
  </head>
  <body class="is-preload">
    <!-- Wrapper -->
    <div id="wrapper">
      <!-- Main -->
      <div id="main">
        <div class="inner">
          <!-- Header -->
					<header id="header">
						<a href="../../index.html" class="logo"><strong>Home</strong></a>
							<ul class="icons">
							<!--<li><a href="https://x.com/integralist" class="icon brands fa-twitter" target="blank"><span class="label">Twitter</span></a></li>-->
							<!--<li><a href="https://instagram.com/wwfsuperstarsofwrestling" class="icon brands fa-instagram" target="blank"><span class="label">Instagram</span></a></li>-->
						</ul>
					</header>

          <!-- Content -->
          <section>
						<!--
            <header class="main">
              <h1>Royal Rumble 1989</h1>
              <p>A Bizarre Spectacle Where the Madness Multiplies</p>
            </header>
            <span class="image main"><img src="../images/rumble-89.jpg" alt="" /></span>
						-->
						<nav>

<ul>
<li><a href="#mocking-in-python">Mocking in Python</a>
<ul>
<li><a href="#introduction">Introduction</a></li>

<li><a href="#unittest-mock-or-mock">unittest.mock or mock</a></li>

<li><a href="#decorator">Decorator</a></li>

<li><a href="#resource-location">Resource location</a></li>

<li><a href="#mock-return-value-vs-side-effect">Mock return_value vs side_effect</a></li>

<li><a href="#mock-nested-calls">Mock Nested Calls</a></li>

<li><a href="#verify-exceptions">Verify Exceptions</a></li>

<li><a href="#clearing-lru-cache">Clearing lru_cache</a></li>

<li><a href="#mock-module-level-global-variables">Mock Module Level/Global Variables</a></li>

<li><a href="#mock-instance-method">Mock Instance Method</a></li>

<li><a href="#mock-class-method">Mock Class Method</a></li>

<li><a href="#mock-entire-class">Mock Entire Class</a></li>

<li><a href="#mock-async-calls">Mock Async Calls</a>
<ul>
<li><a href="#asyncmock">AsyncMock</a></li>

<li><a href="#monkey-patch">Monkey Patch</a></li>

<li><a href="#magicmock-subclass">MagicMock Subclass</a></li>

<li><a href="#async-inline-function">Async Inline Function</a></li>
</ul></li>

<li><a href="#mock-instance-types">Mock Instance Types</a></li>

<li><a href="#mock-builtin-open-function">Mock builtin <code>open</code> function</a></li>

<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul>

</nav>

<h1 id="mocking-in-python">Mocking in Python</h1>

<h2 id="introduction">Introduction</h2>

<p>Mocking resources when writing tests in Python can be confusing if you&rsquo;re unfamiliar with doing such things. In this post I am going to cover various aspects of mocking code, which will hopefully be a useful resource for those who are a bit stuck.</p>

<blockquote>
<p>Note: in the code examples I&rsquo;m using <a href="https://docs.pytest.org/en/latest/" target="_blank">pytest</a>, but for the most part that shouldn&rsquo;t matter.</p>
</blockquote>

<h2 id="unittest-mock-or-mock">unittest.mock or mock</h2>

<p>In order to &lsquo;mock&rsquo; a resource we&rsquo;ll first need the <code>mock</code> module, and this is our first stumbling block: which version do we need? i.e. there&rsquo;s two and they both look to be <em>official</em> (<code>mock</code> and <code>unittest.mock</code>).</p>

<p>The <code>mock</code> module is a backwards compatible library you can download from PyPy, where as <code>unittest.mock</code> is the same thing but only compatible with the version of Python you&rsquo;re using.</p>

<p>So in almost all cases you&rsquo;ll want to import it like so:</p>

<pre><code>import unittest.mock as mock
</code></pre>

<blockquote>
<p>For more examples, see <a href="http://www.voidspace.org.uk/python/mock/examples.html" target="_blank">this reference guide</a></p>
</blockquote>

<h2 id="decorator">Decorator</h2>

<p>The most common way to mock resources is to use a Python decorator around your test function:</p>

<pre><code>@mock.patch(&quot;thing&quot;)
def test_stuff(mock_thing):
    mock_thing.return_value = 123
</code></pre>

<p>In this case, what we&rsquo;re patching (<code>thing</code>) can be a variable or a function.</p>

<p>When you do this you&rsquo;ll need to pass an argument to your function (you can name it whatever you want †) which will be a <a href="https://docs.python.org/3.7/library/unittest.mock.html#unittest.mock.MagicMock" target="_blank"><code>MagicMock</code></a>.</p>

<p>This means if you don&rsquo;t do anything else, then calls to <code>thing</code> will (in the example above at least) result in the value <code>123</code> being returned.</p>

<blockquote>
<p>† convention is to name the variable <code>mock_&lt;noun&gt;</code>.</p>
</blockquote>

<p>If you&rsquo;re mocking multiple things then you&rsquo;ll stack the mock decorators ontop of each other, and pass them along in order to the test function:</p>

<pre><code>@mock.patch(&quot;third&quot;)
@mock.patch(&quot;second&quot;)
@mock.patch(&quot;first&quot;)
def test_stuff(mock_first, mock_second, mock_third):
    ...
</code></pre>

<h2 id="resource-location">Resource location</h2>

<p>It&rsquo;s important to know that when mocking you should specify the location of the resource to be mocked, relevant to where it&rsquo;s <em>imported</em>. This is best explained by way of example&hellip;</p>

<p>Imagine I have a module <code>app.foo</code> and within that module I import another dependency like so:</p>

<pre><code>from app.bar import thing
</code></pre>

<p>You might think that when you call <code>mock.patch</code> that you pass it a reference to the resource like <code>app.bar.thing</code>. That would only be relevant if the resource was being called with that full path within the <code>app.foo</code> module (e.g. if <code>app.foo</code> called <code>app.bar.thing(...)</code>).</p>

<p>If the full namespace path isn&rsquo;t referenced, which it isn&rsquo;t in the above example (notice we import just the <code>thing</code> resource). It means we need to specify the reference namespace to mock as where it&rsquo;s imported:</p>

<pre><code>@mock.patch('app.foo.thing')
</code></pre>

<p>So even though <code>thing</code> exists within <code>app.bar</code> we specify <code>app.foo.thing</code> as <code>app.foo</code> is where we&rsquo;ve imported it for use. This catches people out all the time.</p>

<h2 id="mock-return-value-vs-side-effect">Mock return_value vs side_effect</h2>

<p>If your function has a try/except around it, then you can use <code>side_effect</code> to cause the calling of the function to trigger an Exception as the returned value:</p>

<pre><code>@mock.patch('app.aws.sdk.confirm_sign_up', side_effect=Exception('whoops'))
</code></pre>

<blockquote>
<p>Note: if you had used <code>return_value=Exception('whoops')</code> then the mock would return the string representation of the Exception rather than <em>raising</em> an exception like <code>side_effect</code> does.</p>
</blockquote>

<p>Otherwise if you just need a <em>static</em> value returned, so it&rsquo;s evaluated at the time it&rsquo;s defined (not when it&rsquo;s called), then you can use <code>return_value</code> instead:</p>

<pre><code>@mock.patch('app.security.secret_hash', return_value='###')
</code></pre>

<h2 id="mock-nested-calls">Mock Nested Calls</h2>

<p>Calling a property on a mock returns another mock, so in order to mock very specific properties you&rsquo;ll need to nest your <code>return_value</code> or <code>side_effect</code>:</p>

<pre><code>m = mock.MagicMock()
m.return_value.get.side_effect = [1, 2]
m.return_value.post.return_value = 'foo'

x = m()

x.get()   # 1
x.post()  # foo
x.get()   # 2
</code></pre>

<p>Things can get a little more confusing when you want to verify a specific nested method on a mocked object was called:</p>

<pre><code>import unittest.mock as mock

from tornado.ioloop import IOLoop

@mock.patch(&quot;__main__.IOLoop&quot;)
def foo(mock_ioloop):
    IOLoop.current()
    mock_ioloop.current.assert_called()  # will fail if assertion isn't True

    IOLoop.current().start()
    mock_ioloop.current().start.assert_called()  # will fail if assertion isn't True
</code></pre>

<p>The reason this can get more complicated is due to how a mock will return a new mock when accessing a property on a mock:</p>

<pre><code>import unittest.mock as mock

from tornado.httpserver import HTTPServer

@mock.patch(&quot;__main__.HTTPServer&quot;)
def bar(mock_httpserver):
    server = HTTPServer()

    server.listen(8080)
    HTTPServer().listen(123)

    mock_httpserver.assert_called()
    mock_httpserver().listen.assert_called_with(8080)
</code></pre>

<p>The above code will error:</p>

<pre><code>AssertionError: expected call not found.
Expected: listen(8080)
Actual: listen(123)
</code></pre>

<p>You&rsquo;ll need to make sure you assert the mock at the right time:</p>

<pre><code>import unittest.mock as mock

from tornado.httpserver import HTTPServer

@mock.patch(&quot;__main__.HTTPServer&quot;)
def bar(mock_httpserver):
    server = HTTPServer()
    mock_httpserver.assert_called()
    
    server.listen(8080)
    mock_httpserver().listen.assert_called_with(8080)
    
    HTTPServer().listen(123)
    mock_httpserver().listen.assert_called_with(123)
</code></pre>

<h2 id="verify-exceptions">Verify Exceptions</h2>

<p>If we want to verify that some piece of code throws an <code>Exception</code> type when we need it to we can mock specific resources to throw an exception and then use <code>pytest.raises</code> as a context manager around the caller of our code to be verified.</p>

<p>In the following example our code (in <code>app.account.confirm(...)</code>) catches a generic <code>Exception</code> and re-raises it as <code>exceptions.CognitoException</code>.</p>

<p>We can catch and make assertions against this expected behaviour by first mocking the resource we want to throw an exception and get it to throw our own fake exception using the <code>side_effect</code> parameter.</p>

<p>Next we specify the exact exception type we&rsquo;re expecting to be raised using <code>pytest.raises(T)</code>:</p>

<pre><code>@mock.patch('app.aws.sdk.confirm_sign_up', side_effect=Exception('whoops'))
def test_account_confirm_failure(mock_signup):
    with pytest.raises(exceptions.CognitoException) as exc_info:
        app.account.confirm(123, 'foo')
        assert True is True  # this will never be executed!
        
    assert exc_info.typename == 'CognitoException'
    assert str(exc_info.value) == 'SIGNUP_CONFIRMATION_FAILED'
</code></pre>

<blockquote>
<p>Note: don&rsquo;t make the mistake of putting any assertions within the <code>with</code> context manager. Once the Exception is raised by the function being called within the <code>with</code> context manager, all code after it inside the block is skipped.</p>
</blockquote>

<h2 id="clearing-lru-cache">Clearing lru_cache</h2>

<p>If a function you wish to test has the <code>functools.lru_cache</code> decorator applied, then you&rsquo;ll need to be mindful of mocking the response of that function as it&rsquo;ll be cached in one test and the cached result will be returned when calling the function again to test some other behaviour (and might likely confuse you when you see the unexpected response).</p>

<p>To fix this issue is very easy because <code>lru_cache</code> provides additional functions when decoratoring your functions, it provides:</p>

<ul>
<li><code>cache_info</code></li>
<li><code>cache_clear</code></li>
</ul>

<p>The latter (<code>cache_clear</code>) is what you would need to call. This is demonstrated below:</p>

<pre><code>@lru_cache(5)
def foo():
    print('Executing foo...')
    
foo()  # Executing foo...
foo()  # &lt;nothing printed as None response was cached and returned&gt;
foo.cache_info()  # CacheInfo(hits=1, misses=1, maxsize=5, currsize=1)
foo.cache_clear()
foo()  # Executing foo... (notice the 'side effect of print is executed again)
</code></pre>

<blockquote>
<p>Note: debugging this isn&rsquo;t always obvious. Later on I demonstrate how to <a href="#mock-builtin-open-function">mock the builtin <code>open</code> function</a>, and in that scenario I stumbled across this issue, because although I wasn&rsquo;t mocking the top level function itself (I was mocking the call to <code>open</code> within), the contents of the file being opened was what was returned and being cached.</p>
</blockquote>

<h2 id="mock-module-level-global-variables">Mock Module Level/Global Variables</h2>

<p>With a module variable you can can either set the value directly or use <code>mock.patch</code>.</p>

<p>In the following example we have the variable <code>client_id</code> which is a global variable inside the <code>app.aws</code> module which we import to reference elsewhere in our code:</p>

<pre><code>import app.aws


def test_account_confirm_successful():
    app.aws.client_id = 456  # used internally by `confirm()`
    ...
    
@mock.patch('app.aws.client_id', 456)
def test_account_confirm_successful():
    ...
</code></pre>

<p>In the <code>mock.patch</code> example, there are two key things to notice:</p>

<ol>
<li>we don&rsquo;t use <code>return_value</code>.</li>
<li>there is no mock instance passed to the test function.</li>
</ol>

<p>This is because we&rsquo;re modifying a variable and not a direct function or &lsquo;callable&rsquo; so there&rsquo;s no need to pass a mock into the test function (if you want to change the value a few times within the test itself then you would mock the variable but not immediately assign a value in the decorator).</p>

<h2 id="mock-instance-method">Mock Instance Method</h2>

<p>There are multiple ways to achieve mocking of an instance method. One common approach is to use <code>mock.patch.object</code>, like so:</p>

<pre><code>from unittest import mock

def test_foo():
    with mock.patch.object(FooClass, 'method_of_class', return_value=None) as mock_method:
        instance = SomeClass()
        instance.method_of_class('arg')
        mock_method.assert_called_with('arg')
</code></pre>

<p>Another approach is to mock the method like you would a normal function, but you reference the method via the classname:</p>

<pre><code>def test_bar():
    r = mock.Mock()
    r.content = b'{&quot;success&quot;: true}'

    with mock.patch('requests.get', return_value=r) as get:  # Avoid doing actual GET request
        some_function()  # internally calls requests.get
        get.assert_called_once()
</code></pre>

<p>Another (although more heavy handed) approach for mocking a class instance method is to take advantage of the fact that a Mock will return a new mock instance when called:</p>

<pre><code>@mock.patch(&quot;foo.bar.SomeClass&quot;)
def test_stuff(mock_class):
    mock_class.return_value.made_up_function.return_value = &quot;123&quot;
</code></pre>

<blockquote>
<p>Note: in the above example we mock the <em>entire</em> class, which might not be what you want. If not, then use the previous <code>mock.patch.object</code> example instead.</p>
</blockquote>

<p>The reason the above example works is because we&rsquo;re setting <code>return_value</code> on our mock. Because this is a <code>MagicMock</code> every attribute referenced returns a new mock instance (a function or property you call on a mock doesn&rsquo;t have to exist) and so we call <code>made_up_function</code> on the returned mock, and on <em>that</em> newly created mock we set the final <code>return_value</code> to <code>123</code>.</p>

<p>But as mentioned in the above note, this approach might be a little <em>too</em> blunt depending on what your needs are (whether you care whether you have a some what functioning class or not).</p>

<h2 id="mock-class-method">Mock Class Method</h2>

<p>To mock a class method is a similar approach to mocking an instance method.</p>

<p>One approach might be that you mock the entire class (but now you have one less <code>return_value</code> to assign to):</p>

<pre><code>mock_class.ClassMethodName.return_value = &quot;123&quot;
</code></pre>

<p>Or better yet you should mock it like you would any normal function, but just reference the method via the class:</p>

<pre><code>@mock.patch('myapp.Foo.class_method_name')
def test_classmethod(self, mock_class_method):
    mock_class_method.return_value = &quot;foobar&quot;
</code></pre>

<h2 id="mock-entire-class">Mock Entire Class</h2>

<p>To mock an entire class you&rsquo;ll need to set the <code>return_value</code> to be a new instance of the class.</p>

<pre><code>@mock.patch('myapp.app.Car')
def test_class(self, mock_car):

    class NewCar(object):
        def get_make(self):
            return 'Audi'

        @property
        def wheels(self):
            return 6

    mock_car.return_value = NewCar()
    ...
</code></pre>

<blockquote>
<p>See other class related mocking tips <a href="https://chase-seibert.github.io/blog/2015/06/25/python-mocking-cookbook.html" target="_blank">here</a></p>
</blockquote>

<h2 id="mock-async-calls">Mock Async Calls</h2>

<p>Mocking asynchronous code is probably the most confusing aspect of mocking. My &lsquo;go to&rsquo; solution I&rsquo;ll explain first, but after that I&rsquo;ll share some alternative methods I&rsquo;ve seen and tried in the past.</p>

<p>First consider this asynchronous code inside of a <code>app.foo</code> module:</p>

<pre><code>import app.stuff

async def do_thing(x):
  return await app.stuff.some_concurrent_function(x)
</code></pre>

<p>If we need to mock the coroutine <code>app.stuff.some_concurrent_function</code>, then we can solve this by creating a function that acts as a <a href="https://docs.python.org/3.7/library/asyncio-task.html#asyncio.coroutine" target="_blank">coroutine</a> and allow it to be configurable for different types of responses:</p>

<blockquote>
<p>Note: the example uses <a href="https://www.tornadoweb.org/en/stable/" target="_blank">tornado</a> for running an asynchronous test.</p>
</blockquote>

<pre><code>def make_coroutine(response):
    &quot;&quot;&quot;You could pass response as a mock or a raw data structure, doesn't matter.&quot;&quot;&quot;
    
    async def coroutine(*args, **kwargs):
        &quot;&quot;&quot;*args will be whatever is passed to the original async function.
        
        Meaning you could have a conditional check that let's us change 
        the response to be anything we need.
        &quot;&quot;&quot;

        return response

    return coroutine

class TestThing(tornado.testing.AsyncTestCase):
    @mock.patch('app.stuff.some_concurrent_function')
    @tornado.testing.gen_test
    def test_async_func(self, mock_thing):
        mock_thing.side_effect = make_coroutine('some response')
        result = yield app.foo.do_thing('xyz')
        assert result == 'some response'
</code></pre>

<p>If you do include an <code>if</code> statement within <code>make_coroutine</code>, you could pass in a MagicMock as a simple way of having a single input give you multiple different values back&hellip;</p>

<pre><code>def make_coroutine(response):
    async def coroutine(*args, **kwargs):
        if args[0] == 'x':
            return response.x
        elif args[0] == 'y':
            return response.y
        else:
            return response.default

    return coroutine

m = mock.MagicMock(x=1, y=2, default=3)
coro = make_coroutine(m)
</code></pre>

<p>When dealing with side_effects that need to sometimes trigger an Exception and other times suceed you could use a slightly modified mock implementation that checks if the given response object is callable or not&hellip;</p>

<pre><code>count = 0

def make_side_effect_coroutine(side_effect):
    &quot;&quot;&quot;Side effect friendly mock coroutine.

    In some tests we need to have a mocked coroutine return a different value
    when it's called multiple times, but a mock side_effect can't trigger a
    raised exception when given an iterator, and so we have to construct that
    behaviour ourselves.
    &quot;&quot;&quot;

    async def coroutine(*args, **kwargs):
        return side_effect(*args, **kwargs) if callable(side_effect) else side_effect
    return coroutine
    
@mock.patch('app.thing')
def test_confirm_email_change_failure(self, mock_thing):

    def side_effects(*args, **kwargs):
        &quot;&quot;&quot;Use global var to control mock side effects.&quot;&quot;&quot;

        global count

        if count &gt; 0:
            raise Exception('whoops')

        count += 1
        return  # don't raise an exception the first time around

    mock_thing.side_effect = make_side_effect_coroutine(side_effects)
</code></pre>

<p>If the above approach doesn&rsquo;t work for you, here are some alternatives&hellip;</p>

<h3 id="asyncmock">AsyncMock</h3>

<blockquote>
<p>Note: this utilizes the package <code>pytest-asyncio</code> to help with testing asyncio code</p>
</blockquote>

<p>Let&rsquo;s start with the code to be mocked&hellip;</p>

<pre><code class="language-python">import asyncio

async def sum(x, y):
    await asyncio.sleep(1)
    return x + y
</code></pre>

<p>Now here&rsquo;s how we&rsquo;d mock it&hellip;</p>

<pre><code class="language-python">import pytest
import asyncio

# create a new pytest fixture called mock_sum
#
@pytest.fixture()
def mock_sum(mocker):
    async_mock = AsyncMock()
    mocker.patch('app.sum', side_effect=async_mock)
    return async_mock

    # Python &lt;3.8 would have used
    #
    # future = asyncio.Future()
    # mocker.patch('app.sum', return_value=future)
    # return future

@pytest.mark.asyncio
async def test_sum(mock_sum):
    mock_sum.return_value = 4

    # Python &lt;3.8 would have used
    #
    # mock_sum.set_result(4)

    result = await sum(1, 2)
    assert result == 4
</code></pre>

<h3 id="monkey-patch">Monkey Patch</h3>

<pre><code># allow mock to be used as an await expression...

async def async_response():
    return namedtuple('_', ['body'])('{&quot;state&quot;: &quot;success&quot;}')


def mock_async_expression(our_mock):
    return async_response().__await__()


mock.MagicMock.__await__ = mock_async_expression
</code></pre>

<h3 id="magicmock-subclass">MagicMock Subclass</h3>

<pre><code>class AsyncMock(MagicMock):
    async def __call__(self, *args, **kwargs):
        return super(AsyncMock, self).__call__(*args, **kwargs)
        
class TestHandlers(testing.AsyncTestCase):
    @mock.patch('app.handlers.trigger_soft_cdn_purge', new_callable=AsyncMock)
    @mock.patch('app.handlers.api')
    @testing.gen_test
    async def test_update_cache(self, api_mock, trigger_soft_cdn_purge):
        response = mock.MagicMock()
        response.code = 200
        api_mock.buzz = AsyncMock(return_value=response)
</code></pre>

<h3 id="async-inline-function">Async Inline Function</h3>

<pre><code>@mock.patch('app.buzz_api.api_gateway')
@testing.gen_test
async def test_buzz_api(self, client_mock):
    async def get(url, **kwargs):
        return
        
    client_mock.get.side_effect = get
</code></pre>

<h2 id="mock-instance-types">Mock Instance Types</h2>

<p>When mocking an object you&rsquo;ll find that the mock replaces the entire object and so it can cause tests to pass (or fail) in unexpected ways.</p>

<p>Meaning, if you need to make a mock more like the concrete interface, then there are two ways to do that:</p>

<ol>
<li><code>spec</code></li>
<li><code>wrap</code></li>
</ol>

<p>We can use mock&rsquo;s <code>spec</code> feature to mimic all methods/attributes of the object being mocked. This ensures your mocks have the same api as the objects they are replacing.</p>

<blockquote>
<p>Note: there is a stricter <code>spec_set</code> that will raise an <code>AttributeError</code>.</p>
</blockquote>

<p>This is best demonstrated with an example:</p>

<pre><code>import unittest.mock as mock
import tornado.simple_httpclient

from tornado.httpclient import AsyncHTTPClient


http_client = AsyncHTTPClient()
type(http_client)  # tornado.simple_httpclient.SimpleAsyncHTTPClient

isinstance(http_client, tornado.simple_httpclient.SimpleAsyncHTTPClient)  # True

isinstance(mock.MagicMock(), tornado.simple_httpclient.SimpleAsyncHTTPClient)  # False

m = mock.MagicMock(spec=tornado.simple_httpclient.SimpleAsyncHTTPClient)
isinstance(m, tornado.simple_httpclient.SimpleAsyncHTTPClient)  # True
</code></pre>

<p>The <code>wrap</code> parameter on the other hand allows you to &lsquo;spy&rsquo; on the implementation, as well as affect its behaviour. In the following example I want to spy on the builtin <code>datetime</code> implementation:</p>

<pre><code>@pytest.mark.parametrize(&quot;input_date, input_url, valid&quot;, [
    (&quot;2017-06-17T00:00:00.000000Z&quot;, &quot;foo&quot;, True),
    (&quot;2017-06-18T00:00:00.000000Z&quot;, &quot;bar&quot;, False),
])
@mock.patch(&quot;app.handlers.data.datetime&quot;, wraps=datetime)
def test_valid_video(mock_datetime, input_date, input_url, valid):
    mock_datetime.now.return_value = datetime(2017, 6, 18, 00, 00, 00, 000000)
    assert valid_video(input_date, input_url) is valid
</code></pre>

<p>Another way to use <code>wrap</code> is like so:</p>

<pre><code>from unittest import mock


class Foo(object):
    def bar(self, x, y):
        return x + y + 1

def test_bar():
    foo = Foo()
    with mock.patch.object(foo, 'bar', wraps=foo.bar) as wrapped_foo:
        foo.bar(1, 3)
        wrapped_foo.assert_called_with(1, 2)

test_bar()
</code></pre>

<p>Another simplified version of the above that mocks the whole object, not just a single method:</p>

<pre><code>from unittest import mock

class Foo():
    def bar(self, msg):
        print(msg)

f = Foo()
spy = mock.MagicMock(wraps=f)

spy.bar('baz')
spy.bar.assert_called_with('beep')  # raises AssertionError
</code></pre>

<h2 id="mock-builtin-open-function">Mock builtin <code>open</code> function</h2>

<p>Python&rsquo;s mock library provides an abstraction for mocking the builtin <code>open</code> function a lot simpler&hellip;</p>

<pre><code>def test_load_ui_messages_successful():
    &quot;&quot;&quot;Verify ui message YAML file can be read properly.&quot;&quot;&quot;

    file_content = 'foo: bar'

    with mock.patch('bf_auth.utility.open', mock.mock_open(read_data=file_content), create=True) as mock_builtin_open:
        assert utils.load_ui_messages('./path/to/non/existing/file.yaml') == {'foo': 'bar'}
</code></pre>

<p>The <code>create=True</code> param set on <code>mock.patch</code> means that the <code>mock.MagicMock</code> returned will automagically create any attributes that are called on the mock (this is because the <code>open</code> function will attempt to access lots of different things and it&rsquo;s easier for mock to mock out all of that for you).</p>

<h2 id="conclusion">Conclusion</h2>

<p>There we&rsquo;ll end. Hopefully this list of mocking techniques will be able to see you through even the most complex of code needing to be tested. Let me know what you think on twitter.</p>

          </section>
        </div>
      </div>
      <!-- Sidebar -->
<div id="sidebar">
  <div class="inner">
    <!-- Search -->
    <!--<section id="search" class="alt">-->
    <!--  <form method="post" action="#">-->
    <!--    <input type="text" name="query" id="query" placeholder="Search" />-->
    <!--  </form>-->
    <!--</section>-->
    <!-- Menu -->
    <nav id="menu">
      <header class="major">
        <h2>Menu</h2>
      </header>
      <ul>
        <li><a href="../../index.html">Home</a></li>
        <!--<li><a href="../resume/index.html">Resume</a></li>-->
				
	<li>
	  <span class="opener">Pages</span>
	  <ul>
		
	<li><a href="../../pages/christmas-movies/index.html">Christmas Movies</a></li>
	
	<li><a href="../../pages/resume/index.html">Resume</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2024</span>
	  <ul>
		
	<li><a href="../../posts/go-concurrency-patterns/index.html">Go Concurrency Patterns</a></li>
	
	<li><a href="../../posts/bitwise-operations-in-go/index.html">Bitwise Operations In Go</a></li>
	
	<li><a href="../../posts/go-typed-nil/index.html">Go Typed Nil</a></li>
	
	<li><a href="../../posts/programming-at-the-edge-with-fastly-compute/index.html">Programming At The Edge With Fastly Compute</a></li>
	
	<li><a href="../../posts/ci-cd-with-terraform-cloud-and-github-actions/index.html">Ci Cd With Terraform Cloud And Github Actions</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2023</span>
	  <ul>
		
	<li><a href="../../posts/openapi/index.html">Openapi</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2022</span>
	  <ul>
		
	<li><a href="../../posts/terraform-build-a-provider/index.html">Terraform Build A Provider</a></li>
	
	<li><a href="../../posts/rust-smart-pointers/index.html">Rust Smart Pointers</a></li>
	
	<li><a href="../../posts/laptop-setup-v2/index.html">Laptop Setup V2</a></li>
	
	<li><a href="../../posts/go-install/index.html">Go Install</a></li>
	
	<li><a href="../../posts/neovim-rust-go/index.html">Neovim Rust Go</a></li>
	
	<li><a href="../../posts/vim-themes/index.html">Vim Themes</a></li>
	
	<li><a href="../../posts/dev-tools/index.html">Dev Tools</a></li>
	
	<li><a href="../../posts/go-style-guide/index.html">Go Style Guide</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2021</span>
	  <ul>
		
	<li><a href="../../posts/vim-advanced/index.html">Vim Advanced</a></li>
	
	<li><a href="../../posts/rust-ownership/index.html">Rust Ownership</a></li>
	
	<li><a href="../../posts/github-actions/index.html">Github Actions</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2020</span>
	  <ul>
		
	<li><a href="../../posts/go-reflection/index.html">Go Reflection</a></li>
	
	<li><a href="../../posts/software-comparison/index.html">Software Comparison</a></li>
	
	<li><a href="../../posts/rate-limiting/index.html">Rate Limiting</a></li>
	
	<li><a href="../../posts/git-internals/index.html">Git Internals</a></li>
	
	<li><a href="../../posts/python-context-managers/index.html">Python Context Managers</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2019</span>
	  <ul>
		
	<li><a href="../../posts/python-generators/index.html">Python Generators</a></li>
	
	<li><a href="../../posts/tox-ini/index.html">Tox Ini</a></li>
	
	<li><a href="../../posts/python-app-dependencies/index.html">Python App Dependencies</a></li>
	
	<li><a href="../../posts/python-asyncio/index.html">Python Asyncio</a></li>
	
	<li><a href="../../posts/go-arrays-and-slices/index.html">Go Arrays And Slices</a></li>
	
	<li><a href="../../posts/anonymity/index.html">Anonymity</a></li>
	
	<li><a href="../../posts/http-caching-guide/index.html">Http Caching Guide</a></li>
	
	<li><a href="../../posts/laptop-setup/index.html">Laptop Setup</a></li>
	
	<li><a href="../../posts/git-multiple-branches/index.html">Git Multiple Branches</a></li>
	
	<li><a href="../../posts/algorithms-in-python/index.html">Algorithms In Python</a></li>
	
	<li><a href="../../posts/remote-working/index.html">Remote Working</a></li>
	
	<li><a href="../../posts/python-mocking/index.html">Python Mocking</a></li>
	
	<li><a href="../../posts/calculating-big-o/index.html">Calculating Big O</a></li>
	
	<li><a href="../../posts/algorithmic-complexity-in-python/index.html">Algorithmic Complexity In Python</a></li>
	
	<li><a href="../../posts/data-types-and-data-structures/index.html">Data Types And Data Structures</a></li>
	
	<li><a href="../../posts/design-python/index.html">Design Python</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2018</span>
	  <ul>
		
	<li><a href="../../posts/js-modern/index.html">Js Modern</a></li>
	
	<li><a href="../../posts/engineer-to-manager/index.html">Engineer To Manager</a></li>
	
	<li><a href="../../posts/interview-techniques/index.html">Interview Techniques</a></li>
	
	<li><a href="../../posts/post-mortems/index.html">Post Mortems</a></li>
	
	<li><a href="../../posts/slackbot-opsbot/index.html">Slackbot Opsbot</a></li>
	
	<li><a href="../../posts/go-interfaces/index.html">Go Interfaces</a></li>
	
	<li><a href="../../posts/multigrain-services/index.html">Multigrain Services</a></li>
	
	<li><a href="../../posts/authentication-with-aws-cognito/index.html">Authentication With Aws Cognito</a></li>
	
	<li><a href="../../posts/a-guide-to-effective-1-1-meetings/index.html">A Guide To Effective 1 1 Meetings</a></li>
	
	<li><a href="../../posts/project-management/index.html">Project Management</a></li>
	
	<li><a href="../../posts/reading-list/index.html">Reading List</a></li>
	
	<li><a href="../../posts/python-security/index.html">Python Security</a></li>
	
	<li><a href="../../posts/static-site-search/index.html">Static Site Search</a></li>
	
	<li><a href="../../posts/interview-topics/index.html">Interview Topics</a></li>
	
	<li><a href="../../posts/go-reverse-proxy/index.html">Go Reverse Proxy</a></li>
	
	<li><a href="../../posts/hashing-encryption-encoding/index.html">Hashing Encryption Encoding</a></li>
	
	<li><a href="../../posts/computers-101/index.html">Computers 101</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2017</span>
	  <ul>
		
	<li><a href="../../posts/statistics-basics/index.html">Statistics Basics</a></li>
	
	<li><a href="../../posts/queue-best-practices/index.html">Queue Best Practices</a></li>
	
	<li><a href="../../posts/monitoring-best-practices/index.html">Monitoring Best Practices</a></li>
	
	<li><a href="../../posts/load-testing-guidelines/index.html">Load Testing Guidelines</a></li>
	
	<li><a href="../../posts/logging-101/index.html">Logging 101</a></li>
	
	<li><a href="../../posts/fastly-varnish/index.html">Fastly Varnish</a></li>
	
	<li><a href="../../posts/profiling-python/index.html">Profiling Python</a></li>
	
	<li><a href="../../posts/profiling-go/index.html">Profiling Go</a></li>
	
	<li><a href="../../posts/dev-environments-within-docker-containers/index.html">Dev Environments Within Docker Containers</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2016</span>
	  <ul>
		
	<li><a href="../../posts/key-architecture/index.html">Key Architecture</a></li>
	
	<li><a href="../../posts/go-hitchhikers-guide/index.html">Go Hitchhikers Guide</a></li>
	
	<li><a href="../../posts/concepts-from-the-c-programming-language/index.html">Concepts From The C Programming Language</a></li>
	
	<li><a href="../../posts/man-pages/index.html">Man Pages</a></li>
	
	<li><a href="../../posts/c-and-syscalls/index.html">C And Syscalls</a></li>
	
	<li><a href="../../posts/bits-and-bytes/index.html">Bits And Bytes</a></li>
	
	<li><a href="../../posts/terminal-password-manager/index.html">Terminal Password Manager</a></li>
	
	<li><a href="../../posts/terminal-utils/index.html">Terminal Utils</a></li>
	
	<li><a href="../../posts/github-pull-request-formatting/index.html">Github Pull Request Formatting</a></li>
	
	<li><a href="../../posts/big-o-for-beginners/index.html">Big O For Beginners</a></li>
	
	<li><a href="../../posts/the-perfect-developer/index.html">The Perfect Developer</a></li>
	
	<li><a href="../../posts/git-merge-strategies/index.html">Git Merge Strategies</a></li>
	
	<li><a href="../../posts/grpc-for-beginners/index.html">Grpc For Beginners</a></li>
	
	<li><a href="../../posts/bash-watchtower/index.html">Bash Watchtower</a></li>
	
	<li><a href="../../posts/rpc-variations-in-go/index.html">Rpc Variations In Go</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2015</span>
	  <ul>
		
	<li><a href="../../posts/go-func-type/index.html">Go Func Type</a></li>
	
	<li><a href="../../posts/github-multiple-ssh/index.html">Github Multiple Ssh</a></li>
	
	<li><a href="../../posts/http2/index.html">Http2</a></li>
	
	<li><a href="../../posts/building-systems-with-make/index.html">Building Systems With Make</a></li>
	
	<li><a href="../../posts/client-cert-authentication/index.html">Client Cert Authentication</a></li>
	
	<li><a href="../../posts/dns-101/index.html">Dns 101</a></li>
	
	<li><a href="../../posts/security-basics/index.html">Security Basics</a></li>
	
	<li><a href="../../posts/docker-nginx/index.html">Docker Nginx</a></li>
	
	<li><a href="../../posts/designing-for-simplicity/index.html">Designing For Simplicity</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2014</span>
	  <ul>
		
	<li><a href="../../posts/concurrency/index.html">Concurrency</a></li>
	
	<li><a href="../../posts/github-workflow/index.html">Github Workflow</a></li>
	
	<li><a href="../../posts/functional-recursive-javascript-programming/index.html">Functional Recursive Javascript Programming</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2013</span>
	  <ul>
		
	<li><a href="../../posts/refactoring-techniques/index.html">Refactoring Techniques</a></li>
	
	<li><a href="../../posts/design-mvcp/index.html">Design Mvcp</a></li>
	
	<li><a href="../../posts/basic-shell-scripting/index.html">Basic Shell Scripting</a></li>
	
	<li><a href="../../posts/clean-coder/index.html">Clean Coder</a></li>
	
	<li><a href="../../posts/message-passing-in-object-oriented-code/index.html">Message Passing In Object Oriented Code</a></li>
	
	<li><a href="../../posts/design-oop/index.html">Design Oop</a></li>
	
	  </ul>
	</li>
	
	<li>
	  <span class="opener">2012</span>
	  <ul>
		
	<li><a href="../../posts/git-tips/index.html">Git Tips</a></li>
	
	<li><a href="../../posts/maintainable-css-with-bem/index.html">Maintainable Css With Bem</a></li>
	
	<li><a href="../../posts/host-methods-vs-native-methods/index.html">Host Methods Vs Native Methods</a></li>
	
	<li><a href="../../posts/javascript-101/index.html">Javascript 101</a></li>
	
	  </ul>
	</li>
	
      </ul>
    </nav>
    <!-- Section -->
		<!--
    <section>
      <header class="major">
        <h2>Highlights</h2>
      </header>
      <div class="mini-posts">
        <article>
          <a href="ppv-survivorseries-88.html" class="image"><img src="../images/survivor-88-index.jpg" alt="" /></a>
          <p>Get ready for the ultimate showdown as Survivor Series 1988 brings non-stop tag team action, fierce rivalries, and unforgettable battles between the biggest WWF superstars!</p>
        </article>
        <article>
          <a href="ppv-royalrumble-89.html" class="image"><img src="../images/rumble-89-index.jpg" alt="" /></a>
          <p>Royal Rumble 1989 unleashes chaos with 30 superstars battling for glory in an unforgettable over-the-top-rope showdown!</p>
        </article>
        <article>
          <a href="ppv-summerslam-88.html" class="image"><img src="../images/slam-88-index.jpg" alt="" /></a>
          <p>SummerSlam 1988 delivers explosive action with iconic matchups, as the WWF's biggest stars collide in the hottest event of the summer!</p>
        </article>
      </div>
    </section>
		-->
    <!-- Section -->
    <!--<section>-->
    <!--  <header class="major">-->
    <!--    <h2>Get in touch</h2>-->
    <!--  </header>-->
    <!--  <p>Sed varius enim lorem ullamcorper dolore aliquam aenean ornare velit lacus, ac varius enim lorem ullamcorper dolore. Proin sed aliquam facilisis ante interdum. Sed nulla amet lorem feugiat tempus aliquam.</p>-->
    <!--  <ul class="contact">-->
    <!--    <li class="icon solid fa-envelope"><a href="#">information@untitled.tld</a></li>-->
    <!--    <li class="icon solid fa-phone">(000) 000-0000</li>-->
    <!--    <li class="icon solid fa-home">1234 Somewhere Road #8254<br />-->
    <!--      Nashville, TN 00000-0000</li>-->
    <!--  </ul>-->
    <!--</section>-->
    <!-- Footer -->
    <footer id="footer">
      <p class="copyright">&copy; Integralist. All rights reserved.</p>
      <p class="copyright small">Demo Images: <a href="https://unsplash.com">Unsplash</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p>
    </footer>
  </div>
</div>

    </div>
    <!-- Scripts -->
    <script src="../../assets/js/jquery.min.js"></script>
    <script src="../../assets/js/browser.min.js"></script>
    <script src="../../assets/js/breakpoints.min.js"></script>
    <script src="../../assets/js/util.js"></script>
    <script src="../../assets/js/main.js"></script>

		<!-- The following script is for handling the automatic TOC generated by `make build` -->
		<script>
		// Get references to the elements
		const nav = document.querySelector('#main nav');
		const h1 = document.querySelector('#main h1');

		// Move the `nav` element to be underneath the `h1`
		h1.insertAdjacentElement('afterend', nav);

		// Hide the `nav` element by default using inline styles
		nav.style.display = 'none';

		// Create a new `h2` element with the text "TOC"
		const toc = document.createElement('h2');
		toc.textContent = 'TOC';
		toc.className = "toc"

		// Add inline styles to make the `h2` look clickable
		// DISABLED: done with className
		//
		// toc.style.cursor = 'pointer';
		// toc.style.color = 'blue';
		// toc.style.textDecoration = 'underline';

		// Add a click event listener to toggle the visibility of the `nav`
		toc.addEventListener('click', () => {
				nav.style.display = nav.style.display === 'none' ? 'block' : 'none';
		});

		// Insert the `h2` element above the `nav`
		nav.insertAdjacentElement('beforebegin', toc);
		</script>

		<!-- The following script highlights the current page in the side nav -->
		<script>
		// Get the current page's URL path and normalize it
    const currentUrl = window.location.pathname;
    const normalizedCurrentUrl = currentUrl
        .replace(/.*\/(pages|posts)\//, '/$1/') // Ensure leading slash and extract from `pages/` or `posts/`
        .replace(/index\.html$/, ''); // Remove `index.html` suffix

    // Select all menu links
    const links = document.querySelectorAll('#menu ul li a');

    let matchedParentSpan = null;

    links.forEach(link => {
        // Normalize the link's href for comparison
        const normalizedHref = link.getAttribute('href')
            .replace(/^(\.\.\/)+/, '/') // Convert `../../` to `/` for consistency
            .replace(/index\.html$/, ''); // Remove `index.html` suffix

        // Check if the normalized href matches the normalized current URL
        if (normalizedHref === normalizedCurrentUrl) {
            // Add the inline style to the matching link
            link.style.color = 'black';

            // Find the parent span with the class 'opener'
            matchedParentSpan = link.closest('ul').previousElementSibling;
        }
    });

    // If a matching parent span was found, add the 'active' class
    if (matchedParentSpan && matchedParentSpan.classList.contains('opener')) {
        matchedParentSpan.classList.add('active');
    }
		</script>
  </body>
</html>
